<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nummer kiezen & afstrepen</title>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; margin: 24px; background: #f8fafc; color: #0f172a; }
    header { margin-bottom: 16px; }
    .card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    .row { display: flex; flex-wrap: wrap; gap: 10px; }
    .slot { flex: 0 0 60px; height: 60px; display: grid; place-items: center; border-radius: 10px; border: 1px solid #cbd5e1; cursor: pointer; background: #f1f5f9; font-weight: 600; }
    .slot.taken { background: #ffe4e6; color: #be123c; border-color: #fecdd3; cursor: not-allowed; position: relative; }
    .slot.taken::after { content: "×"; position: absolute; right: 6px; top: 2px; font-weight: 700; }
    .slot.mine { background: #dcfce7; color: #166534; border-color: #bbf7d0; }
    .label { font-size: 12px; color: #64748b; margin-top: 6px; }
    .hidden { display: none; }
    button { background: #0ea5e9; color: white; border: none; border-radius: 8px; padding: 10px 14px; cursor: pointer; font-weight: 600; }
    button:disabled { background: #94a3b8; cursor: not-allowed; }
    input[type="text"] { padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; width: 260px; }
    .small { font-size: 12px; color: #475569; }
    footer { margin-top: 24px; color: #64748b; }
  </style>
</head>
<body>
  <header>
    <h1>Lootjes: kies een nummer</h1>
    <p class="small">Kies een vrij nummer. Zodra je kiest, wordt het voor iedereen afgestreept.</p>
  </header>

  <section class="card" id="loginCard">
    <h2>Jouw naam</h2>
    <p class="small">Deze naam wordt getoond naast jouw gekozen nummer.</p>
    <input id="displayName" type="text" placeholder="Bijv. Patrick" />
    <button id="enterBtn">Ga verder</button>
  </section>

  <section class="card hidden" id="gridCard">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2>Nummers</h2>
      <button id="resetBtn" class="hidden">Reset lijst</button>
    </div>
    <div id="grid" class="row"></div>
    <p class="label" id="status"></p>
  </section>

  <section class="card hidden" id="mappingCard">
    <h2>Jouw gerecht</h2>
    <p id="myDish" class="label"></p>
  </section>

  <footer>
    <p class="small">Deel deze link in WhatsApp. Iedereen ziet realtime wat al gekozen is.</p>
  </footer>

  <!-- Vervang onderstaand deel met jouw databaseconfiguratie -->
  <script>
    // ====== Configuratie voor realtime opslag ======
    // Voorbeeld met Supabase (gratis, eenvoudig). Maak een project en vervang de onderstaande waarden.
    const SUPABASE_URL = "https://YOUR-PROJECT.supabase.co";
    const SUPABASE_ANON_KEY = "YOUR-ANON-KEY";

    // ====== Voorbeeld data ======
    const TOTAL_NUMBERS = 12; // Pas aan naar jouw aantal
    // Optioneel: nummers -> gerechten mapping (alleen zichtbaar na keuze)
    const DISHES = {
      1: "Tiramisu",
      2: "Stamppot andijvie",
      3: "Pompoensoep",
      4: "Kip curry",
      5: "Quiche lorraine",
      6: "Bruschetta",
      7: "Lasagne",
      8: "Caesar salad",
      9: "Brownies",
      10: "Hummus platter",
      11: "Pannenkoeken",
      12: "Stoofpeertjes"
    };

    // ====== Supabase client ======
    // Laad Supabase uit CDN
    (function loadSupabase() {
      const s = document.createElement('script');
      s.src = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.46.1/dist/umd/supabase.js";
      s.onload = () => init();
      document.head.appendChild(s);
    })();

    let supabaseClient = null;
    let session = { name: null, myNumber: null };

    async function init() {
      supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // Zorg voor tabellen (eenmalig in je project aanmaken):
      // TABLE: slots (columns: number int primary key, taken boolean default false, owner text)
      // TABLE: settings (columns: key text primary key, value text)
      // Je kunt dit via de Supabase SQL editor doen:
      // CREATE TABLE IF NOT EXISTS slots (number int primary key, taken boolean default false, owner text);
      // CREATE TABLE IF NOT EXISTS settings (key text primary key, value text);

      // UI hooks
      document.getElementById('enterBtn').onclick = enter;
      document.getElementById('resetBtn').onclick = resetAll;

      // Real-time subscribe
      supabaseClient
        .channel('slots')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'slots' }, refreshGrid)
        .subscribe();

      await ensureSeed();
      await render();
    }

    async function ensureSeed() {
      const { data, error } = await supabaseClient.from('slots').select('number');
      if (error) { console.error(error); return; }
      if (data.length === 0) {
        const rows = Array.from({ length: TOTAL_NUMBERS }, (_, i) => ({ number: i + 1, taken: false, owner: null }));
        const { error: insErr } = await supabaseClient.from('slots').insert(rows);
        if (insErr) console.error(insErr);
      }
    }

    async function enter() {
      const name = document.getElementById('displayName').value.trim();
      if (!name) return alert('Vul een naam in.');
      session.name = name;
      document.getElementById('loginCard').classList.add('hidden');
      document.getElementById('gridCard').classList.remove('hidden');
      await render();
    }

    async function render() {
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      const { data: slots, error } = await supabaseClient.from('slots').select('*').order('number');
      if (error) { console.error(error); return; }

      slots.forEach(slot => {
        const div = document.createElement('div');
        div.className = 'slot' + (slot.taken ? ' taken' : '') + (slot.owner === session.name ? ' mine' : '');
        div.textContent = slot.number;
        div.title = slot.taken ? (slot.owner ? `Gekozen door ${slot.owner}` : 'Reeds gekozen') : 'Klik om te kiezen';
        div.onclick = () => choose(slot);
        grid.appendChild(div);
      });

      const status = document.getElementById('status');
      const mine = slots.find(s => s.owner === session.name);
      session.myNumber = mine?.number || null;
      status.textContent = session.myNumber
        ? `Je hebt nummer ${session.myNumber} gekozen.`
        : 'Je hebt nog geen nummer gekozen.';

      // Toon gerecht na keuze
      const mappingCard = document.getElementById('mappingCard');
      const myDish = document.getElementById('myDish');
      if (session.myNumber) {
        mappingCard.classList.remove('hidden');
        myDish.textContent = `Jouw gerecht: ${DISHES[session.myNumber] ?? 'Onbekend'}`;
      } else {
        mappingCard.classList.add('hidden');
      }

      // Toon resetknop als beheerder (optioneel: maak een simpele “admin code”)
      const isAdmin = false; // zet op true als je zelf wilt resetten
      document.getElementById('resetBtn').classList.toggle('hidden', !isAdmin);
    }

    async function choose(slot) {
      if (!session.name) return alert('Vul eerst je naam in.');
      if (slot.taken) return;
      // Check of deze gebruiker al gekozen heeft
      const { data: mine } = await supabaseClient.from('slots').select('*').eq('owner', session.name);
      if (mine && mine.length > 0) {
        return alert('Je hebt al een nummer gekozen.');
      }
      // Claim atomisch (voorkomt dat twee mensen tegelijk hetzelfde nummer kiezen)
      const { data, error } = await supabaseClient
        .from('slots')
        .update({ taken: true, owner: session.name })
        .eq('number', slot.number)
        .eq('taken', false)
        .select();

      if (error) { console.error(error); return; }
      if (!data || data.length === 0) {
        alert('Iemand anders was net sneller. Kies een ander nummer.');
      } else {
        refreshGrid();
      }
    }

    async function refreshGrid() {
      await render();
    }

    async function resetAll() {
      if (!confirm('Alles resetten?')) return;
      const { error } = await supabaseClient.from('slots').update({ taken: false, owner: null }).neq('number', 0);
      if (error) console.error(error);
      await render();
    }
  </script>
</body>
</html>
